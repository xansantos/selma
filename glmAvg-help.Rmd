---
title: "selma: Smooth relative SELectivity curves
#          using weighted polynomial basis via Model Averaging"
author: "Milanelli et al"
date:   "October, 2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Initials

Make sure you have already installed the following packages you will need to run the analysis:

```{r library, include=TRUE,message=FALSE}
library(data.table)
library(ggplot2)
library(MuMIn)
library(doParallel)
library(foreach)
```

source the selma functions to run the analysis

```{r selmafuns, include=TRUE,message=FALSE}
lapply(grep("funs",list.files()), function(i) source(list.files()[i],echo=TRUE))
```


load plaice **PLE** example data in Milanelli et al, 

```{r load model objects, include=TRUE}

PLE<-fread("./data/PLE.csv")

```


### Catch comparison analysis in trawl gears

This is an example on how to conduct a model-averaging analysis in catch comparison studies using `selR`. In catch comparison analysis for trawls, the catches in two (or more) catch compartments (codends) are compared. The method can also be applied to explore selectivity data from any other type of experiments (for example paired-gear in which one of the trawls is not selective). The resampling method needed to create bootstrap confidence intervals around the average curve estimated by the model  assumes that 

  + Data is collected by two gears (trawls) fishing in paralell, thus exploiting the same fishing populations 
  + Primary sampling unit is haul

In a first step, the functions required to run the model-averaging analysis needs to be loaded from a R workspace named `glmAvg-Linux.RData` for Linux users, or `glmAvg-Win.RData`. To successfully do it, do not forget to replace the directory path where the required functions are stored in your machine:

```{r load workspace, include=TRUE}

load(file=paste0("/home/santos/Documents/",
                 "2_CRUISES/2023/solea/SO819_820_FT_NS/11-software/R-glmAvg/",
                 "glmAvg-Win.RData"))

```

In the next step, the data to be analyzed is loaded. Again, to successfully do it, do not forget to replace the directory path where the data you are calling is stored in your machine:

```{r load data, include=TRUE}

shrimpdata_letterbox_vs_control <- readRDS(paste0("/home/santos/Documents/2_CRUISES/2023/",
                                                  "solea/SO819_820_FT_NS/4-dataR/Scanner/",
                                           "SO811-ShrimpLengths_letterbox_vs_control.rds"))

```

The data structure in `shrimpdata_letterbox_vs_control` is
 
```{r structure data, include=TRUE}

head(shrimpdata_letterbox_vs_control)

```

where

  + **l** = shrimp length class
  + **n_letterbox** = counts of measured fish at length `l` one of the gears, here the test one.
  + **n_control** = counts of measured fish at length `l`  in the other gear, here the control (non-selective) one (it could be a second test as well)
  + **q_letterbox** and **q_control** = raising factors for `n_letterbox` and `n_control`, respectively

To be able to analize the data with `glmAvg_boot()`, we will have to assign different names to `n_` and `q_` variables:

```{r renaming, include=TRUE}

setnames(shrimpdata_letterbox_vs_control, 
         c("n_letterbox","n_control","q_letterbox","q_control"), # old names
         c("n_1","n_2","q_1","q_2")) # new names

```

The function with model-averaging and bootstrap capabilities is named `glmAvg_boot()` and can be called from the workspace. It requires the following arguments:

  + **X** = input catch data. The structure and column names must be the same as `data_shrimp`.
  + **ncores** = number of cores of the computer allocated for paralellization.
  + **lengthRange** = minimum and maximum lengths in the data set to be used in the analysis, normally lengthRange= the range in the data.
  + **typePredict** = which type of prediction should the model provide. Use `response` as default. 
  + **Rank**= criteria for model averaging, use `AICc` as default.
  + **sampler**= type of resampling function to be used during the bootstrapping, use `bootsampler` for trawl gears
  + **exportfuns**=c(`sampler`,`pooldata`,`glmAvg`) only applied for windows machines. 
  + **type_boot**= resampling technique to be applied in the second loop of the boostrap resampling. use `comp` as the multinomial default one
  + **B**= number of bootstrap iterations.Use `B=1000` as default.

To run the analysis, use the following chunk (be aware that it will take some time to get an output:

```{r analysis trawl, include=TRUE, eval=FALSE}

shrimpmodel_letterbox_vs_control <- glmAvg_boot(X = shrimpdata_letterbox_vs_control,
                                ncores = 2,
                                lengthRange = range(shrimpdata_letterbox_vs_control$l),
                                typePredict = "response",
                                Rank = "AICc",
                                sampler = "bootsampler",
                                exportfuns = c("sampler","pooldata","glmAvg"),
                                type_boot = "multinom",
                                B=1000)

```

The model output is a list of objects including model arguments used, catch data pooled, and model predictions

```{r output model trawl, include=TRUE}

names(shrimpmodel_letterbox_vs_control)

```
where:

  + **B**= number of bootstrap iterations used.
  + **typePredict** =  type of prediction computed
  + **type_boot**= resampling technique applied
  + **catch_data** = input data pooled across hauls for plotting purposes 
  + **ccl.ci** = catch comparison curve with bootstrap confidence intervals
  + **crl.ci** = catch ratio curve with bootstrap confidence intervals

The listed objects can be extracted from the model output by a call within double bracket, for example `mod_shrimp_trawl[["ccl.ci"]]`  

To plot the estimated catch comparison curve against the experimental catch comparison data, `ccl.ci` and `catch_data` stored in the model object `mod_shrimp_trawl` need to be used:

```{r ccplot analysis trawl, include=TRUE, eval=TRUE}
p_cc_shrimp_letterbox_vs_control<-ggplot(data=shrimpmodel_letterbox_vs_control[["ccl.ci"]],aes(x=l))+
  coord_cartesian(xlim=c(15,80),ylim=c(0,1))+
  geom_hline(yintercept = 0.5,col="darkgreen")+
  geom_line( aes(y=mu),col=2,lwd=1.5) + xlab("shrimp length [mm]") +ylab("catch propotion in TEST gear")+
  geom_ribbon(aes(ymin=lci, ymax=uci), alpha=0.2)+
  geom_point(data=shrimpmodel_letterbox_vs_control[["catch_data"]],aes(x=l,y=p_l,size=n_l), alpha=.5,col="darkblue")+
  ggtitle("Letterbox trawl (TEST) vs CONTROL")+
  theme(plot.title = element_text(color="darkgreen", size=14, face="bold"), legend.position="none")

print(p_cc_shrimp_letterbox_vs_control)
```

To plot the catch ratio curve derived from the comparison curve only the object `crl.ci` stored in the model object `mod_shrimp_trawl` needs to be used:

```{r crplot analysis trawl, include=TRUE, eval=TRUE}
p_cr_shrimp_letterbox_vs_control<-ggplot(data=shrimpmodel_letterbox_vs_control[["crl.ci"]],aes(x=l))+
  coord_cartesian(xlim=c(15,80),ylim=c(0,3))+
  geom_hline(yintercept = 1,col="darkblue")+
  geom_line( aes(y=mu),col=2,lwd=1.5) + xlab("shrimp length [mm]") +ylab("Ratio of catches TEST to CONTROL")+
  geom_ribbon(aes(ymin=lci, ymax=uci), alpha=0.2)+
  ggtitle("Letterbox trawl (TEST) vs CONTROL")+
  theme(plot.title = element_text(color="darkblue", size=14, face="bold"), legend.position="none")

print(p_cr_shrimp_letterbox_vs_control)
```



